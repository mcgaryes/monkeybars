/*!
* MonkeyBars v0.9.10
* Task library that provides a simple structure for handling singular, sequential and parallel units of code. 
* https://github.com/mcgaryes/monkeybars/
*/
(function(){"use strict";var e=0,t=1,n=2,r=3,i=4,s="parallel",o="sequence",u="simple",a=0,f=10,l=20,c=30,h="for",p="when",d="while",v="tid",m=100,g="Override Needed",y="Undefined Task",b="No Attributes",w="Unknown Task Type",E="Invalid Arguments",S="Unhandled 'postMessage'",x=this,T=0,N=["name","tid","id","data","type","concurrent","worker","displayName","state","logLevel","timeout","dependencies","group","processed","tasks","currentIndex","processedIndex","max","dependencyMap","count","interval"],C=x.MonkeyBars={};typeof exports!="undefined"&&typeof module!="undefined"&&module.exports&&(exports=module.exports=C);var k=function(e){if(!e){e.logLevel>=f&&console.log(b);return}var t;if(e.tid)t=e;else{var n=e.type,r=e.tasks;r&&(e.tasks=L(r));if(n)if(n===u)t=new q(e);else if(n===o)t=new z(e);else{if(n!==s)throw w;t=new U(e)}else r?t=new z(e):t=new q(e)}return t},L=function(e){var t=[];if(e)for(var n=0;n<e.length;n++)t.push(k(e[n]));return t},A=function(e){var t={};for(var n in e)t[n]={value:e[n],writable:!0};return t},O=function(t){t.state=e,t.processed=!1;if(t.type!==u&&t.tasks){t.currentIndex=0,t.processedIndex=0;for(var n=0;n<t.tasks.length;n++)O(t.tasks[n])}},M=function(e){var t=T++,n=e?e+t:v+t;return n},_=function(e,t){var n=e.dependencies;if(n){var r=n.length;for(var i=0;i<r;i++){var s=n[i];if(s.tid===t.tid)return!0;if(s===t.id)return!0;if(s===t.name&&t.name!=="undefined")return!0}}return!1},D=function(e){if(typeof e.toSource!="undefined"&&typeof e.callee=="undefined")return e.toSource();if(typeof e=="number"||typeof e=="boolean"||typeof e=="function")return e;if(typeof e=="string")return"'"+e+"'";if(typeof e=="object"){var t;if(e.constructor===Array||typeof e.callee!="undefined"){t="[";var n,r=e.length;for(n=0;n<r-1;n++)t+=D(e[n])+",";t+=D(e[n])+"]"}else{t="{";var i;for(i in e)t+=i+":"+D(e[i])+",";t=t.replace(/\,$/,"")+"}"}return t}return"UNKNOWN"},P=function(e){var t="var console = { log: function(msg) { postMessage({ type: 'console', message: msg }); } };",n;e.worker!==undefined?typeof e.worker=="function"?n=new e.worker(e):e.worker.constructor!==undefined&&typeof e.worker.constructor=="function"&&(n=new e.worker.constructor(e)):n=new I(e);var r="var workerTask = "+D(n)+"; workerTask.performTask();",i="onmessage = function(e) {"+t+r+"};";return new Blob([i],{type:"text/javascript"})},H=function(e,t){var n=x.URL||x.webkitURL,r=new Worker(n.createObjectURL(e));return r.onmessage=function(e){e.data.type==="complete"?t.complete(e.data.value):e.data.type==="fault"?t.fault(e.data.value):e.data.type==="cancel"?t.cancel():e.data.type==="console"?console.log(e.data.message):t.worker!==undefined&&typeof t.worker.handler=="function"?t.worker.handler(e):t.logLevel>f&&console.log(S+": "+D(e.data))},r.onerror=function(e){t.fault("WebWorker error.")},r},B=function(e){if(typeof Worker=="undefined"||typeof Blob=="undefined"||e.type!==u){e.logLevel>=f&&e.type===u&&console.log("Cannot perform '"+e.displayName+"' on seperate thread. Web Workers are not supported."),e.performTask();return}e.logLevel>=c&&console.log("Performing '"+e.displayName+"' Functionality With Web Worker");var t=H(P(e),e);t.postMessage()},j=function(e,t){e.decorators=[],e.count&&W(e),e.when&&V(e),e.doWhile&&X(e)},F=function(e){var t=this,n=function(){t.apply(this,arguments)},r=A(e);return n.prototype=Object.create(t.prototype,r),n},I=C.WorkerTask=function(e){if(!e)throw E;e.data!==undefined&&(this.data=e.data),this.performTask=e.performTask};I.prototype={complete:function(e){this.postMessage("complete",e)},fault:function(e){this.postMessage("fault",e)},cancel:function(){this.postMessage("cancel")},postMessage:function(e,t){var n={};e!==undefined&&typeof e=="string"&&(n.type=e),t!==undefined&&(n.value=t),postMessage(n)}},I.extend=F;var q=C.Task=function(e){var t=this;t.tid=M();for(var n in e)if(e.hasOwnProperty(n)){var r=!0;for(var i=0;i<N.length;i++)if(n===N[i]||typeof e[n]=="function"){r=!1;break}r?(t.options===undefined&&(t.options={}),t.options[n]=e[n]):t.hasOwnProperty(n)||(t[n]=e[n])}j(t,e),t.initialize(t.options)};q.prototype=Object.create({},{data:{value:undefined,writable:!0},handleData:{value:function(e){if(arguments.length<0)return;this.data=e},writable:!0},type:{value:u,writable:!0},concurrent:{value:!1,writable:!0},worker:{value:undefined,writable:!0},displayName:{get:function(){return this.id?this.id:this.name?this.name:this.type}},state:{value:e,writable:!0},logLevel:{value:a,writable:!0},timeout:{value:undefined,writable:!0},cancel:{value:function(){if(this.state>t)return;this.state=n,this.logLevel>=l&&console.log("Canceled:"+this.displayName),this.timeoutId&&clearTimeout(this.timeoutId),this.onChange(this.state),this.onCancel()},writable:!0},complete:{value:function(e){if(this.state>t)return;this.state=i,this.logLevel>=l&&console.log("Completed:"+this.displayName),this.timeoutId&&clearTimeout(this.timeoutId),this.executionTime=(new Date).getTime()-this.startTime,arguments.length>0&&this.handleData(e),this.onComplete(e),this.onChange(this.state,e)},writable:!0},fault:{value:function(e){if(this.state>=n)return;this.state=r,this.logLevel>=l&&console.log("Faulted:"+this.displayName),this.timeoutId&&clearTimeout(this.timeoutId),this.onChange(this.state,undefined,e),this.onFault(e)},writable:!0},onChange:{value:function(e,t,n){},writable:!0},onStart:{value:function(){},writable:!0},onFault:{value:function(e){},writable:!0},onComplete:{value:function(e){},writable:!0},onCancel:{value:function(){},writable:!0},performTask:{value:function(){throw"performTask: "+g},writable:!0},start:{value:function(){if(this.state>=t)return;this.startTime=(new Date).getTime(),this.state=t,this.logLevel>=l&&console.log("Started:"+this.displayName);if(this.timeout!==undefined){var e=this;this.timeoutId=setTimeout(function(){e.fault()},this.timeout)}this.onChange(this.state),this.concurrent?B(this):this.performTask(),this.onStart()},writable:!0},initialize:{value:function(e){},writable:!0}}),q.extend=F;var R=C.TaskGroup=function(e){var t=this;e&&(t.tasks=L(e.tasks)),t.dependencyMap={};if(t.tasks)for(var n=0;n<t.tasks.length;n++){var r=t.tasks[n];this.dependencyMap[r.tid]=[],t.setDependeciesForTask(r)}q.call(t,e)};R.prototype=Object.create(q.prototype,{currentIndex:{value:0,writable:!0},processedIndex:{value:0,writable:!0},addSubTask:{value:function(e){if(!e)throw"addSubTask: "+E;e.tid||(e=k(e)),this.setDependeciesForTask(e),this.tasks.push(e)},writable:!0},addSubTaskAfterTask:{value:function(e,t){if(!e||!t)throw"addSubTaskAfterTask: "+E;if(!e||this.state===n)return;e.tid||(e=k(e)),this.setDependeciesForTask(e);var r=this.tasks.indexOf(t);this.tasks.splice(r+1,0,e)},writable:!0},addSubTaskBeforeTask:{value:function(e,t){if(!e||!t)throw"addSubTaskBeforeTask: "+E;if(!e||this.state===n)return;e.tid||(e=k(e)),this.setDependeciesForTask(e);var r=this.tasks.indexOf(t);this.tasks.splice(r,0,e)},writable:!0},onSubTaskComplete:{value:function(e,t){t!==undefined&&this.handleData(t)},writable:!0},onSubTaskFault:{value:function(e,t){this.fault(t)},writable:!0},onSubTaskCancel:{value:function(e){for(var t=0;t<this.tasks.length;t++)_(this.tasks[t],e)&&(this.tasks[t].state=n)},writable:!0},processSubTask:{value:function(e){if(!e){this.logLevel>=f&&console.log(y);return}return e.state===n?(this.onSubTaskCancel(e),!0):(this.processedIndex++,e.group=this,e.data=this.data,e.concurrent=this.concurrent,e.processed=!0,e.logLevel=this.logLevel,e.onChange=function(e,t,s){e===i?this.group.onSubTaskComplete(this,t):e===r?this.group.onSubTaskFault(this,undefined,s):e===n&&this.group.onSubTaskCancel(this)},e.start(),!1)},writable:!0},removeSubTask:{value:function(e){if(!e)return;var t=this.tasks.indexOf(e);this.tasks.splice(t,1)},writable:!0},getTaskByTid:{value:function(e){for(var t=0;t<this.tasks.length;t++){var n=this.tasks[t];if(n.tid===e)return n}},writable:!0},getTaskById:{value:function(e){for(var t=0;t<this.tasks.length;t++){var n=this.tasks[t];if(n.id===e)return n}},writable:!0},getTaskByName:{value:function(e){for(var t=0;t<this.tasks.length;t++){var n=this.tasks[t];if(n.name===e)return n}},writable:!0},cancel:{value:function(){q.prototype.cancel.call(this);for(var t=0;t<this.tasks.length;t++){var r=this.tasks[t];r.state>e?r.cancel():r.state=n}},writable:!0},setDependeciesForTask:{value:function(e){if(e.dependencies){var t=e.dependencies.length;for(var n=0;n<t;n++){var r=e.dependencies[n];r.tid?this.dependencyMap[e.tid].push(r.tid):this.dependencyMap[e.tid].push(r)}}},writable:!1}}),R.extend=F;var U=C.ParallelTask=function(e){var t=this;R.call(t,e)};U.prototype=Object.create(R.prototype,{type:{value:s,writable:!0},max:{value:0,writable:!0},hasNoEnabledSubTasks:{value:function(){if(!this.tasks)return!0;for(var e=0;e<this.tasks.length;e++){var t=this.tasks[e];if(t.state!==n)return!1}return!0},writable:!0},processSubTask:{value:function(e){if(e!==undefined&&e.dependencies!==undefined){var n=e.dependencies.length,r=n,i=0,s=[];for(var o=0;o<n;o++){var u=e.dependencies[o];s.push(u.displayName),u.state>t&&i++}if(i<r){this.logLevel>=c&&console.log("Cannot process "+e.displayName+" until its dependencies ["+s.join(",")+"] have run");return}}R.prototype.processSubTask.call(this,e)},writable:!0},processSubTasks:{value:function(){var e=this.max===0?this.tasks.length:this.max;for(var t=0;t<e;t++){var n=this.tasks[t];n.processed||this.processSubTask(n)}},writable:!0},addSubTask:{value:function(e){if(!e||e.state===n)return;this.currentIndex++,e.tid||(e=k(e)),this.tasks.push(e),this.processSubTask(e)},writable:!0},onSubTaskComplete:{value:function(e,t){this.currentIndex++,this.currentIndex===this.tasks.length?this.group!==undefined?this.complete(this.data):this.complete():(R.prototype.onSubTaskComplete.call(this,e,t),this.processSubTasks())},writable:!0},performTask:{value:function(){this.hasNoEnabledSubTasks()?this.complete():this.processSubTasks()},writable:!0}}),U.extend=F;var z=C.SequenceTask=function(e){var t=this;R.call(t,e)};z.prototype=Object.create(R.prototype,{type:{value:o,writable:!0},startNextSubTask:{value:function(){if(this.state>=n)return;if(this.tasks&&this.currentIndex<this.tasks.length){var e=this.tasks[this.currentIndex++],t=this.processSubTask(e);t&&(this.logLevel>=l&&console.log("Skipped: "+e.displayName+" Group: "+this.displayName),this.startNextSubTask())}else this.group!==undefined?this.complete(this.data):this.complete()},writable:!0},onSubTaskComplete:{value:function(e,t){if(this.state===n)return;R.prototype.onSubTaskComplete.call(this,e,t),this.startNextSubTask()},writable:!0},onSubTaskCancel:{value:function(e){R.prototype.onSubTaskCancel.call(this,e),this.state!==n&&this.startNextSubTask()},writable:!0},performTask:{value:function(){this.startNextSubTask()},writable:!0}}),z.extend=F;var W=function(e){e.decorators.push(h),e.itterationIndex=0,e.complete=function(){this.itterationIndex!==this.count-1?(O(this),this.itterationIndex++,this.logLevel>=l&&console.log("Completed:"+this.displayName+" "+this.itterationIndex+" out of "+this.count+" times"),this.performTask()):q.prototype.complete.call(this)}},X=function(t){t.decorators.push(d),t.interval=t.interval?t.interval:m,t.complete=function(){if(this.doWhile()){this.state=e;var t=this;this.interval!==0?setTimeout(function(){O(t),t.start()},this.interval):t.start()}else q.prototype.complete.call(this)}},V=function(e){e.decorators.push(p),e.interval=e.interval?e.interval:m,e.start=function(){var e=this,t=setInterval(function(){e.when()&&(q.prototype.start.call(e),clearInterval(this))},this.interval)}};C.TaskStates={Initialized:e,Started:t,Canceled:n,Faulted:r,Completed:i},C.TaskTypes={Parallel:s,Sequence:o,Simple:u},C.LogLevels={None:a,Error:f,Info:l,Verbose:c},C.TaskDecorators={For:h,When:p,While:d}}).call(this);