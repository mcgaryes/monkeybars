(function(){var e=0,t=1,n=2,r=3,i=4,s="parallel",o="sequence",u="simple",a="for",f="when",l="while",c="tid",h=this,p=0,d={},v=function(e){var t;if(!e)throw"No options passed";var n=e.type,r=e.tasks;return n?n==u?w.extend(e):n==o?x.extend(e):n==s?S.extend(e):t:r?x.extend(e):w.extend(e)},m=function(e){var t=[];if(e)for(var n=0;n<e.length;n++)t.push(v(e[n]));return t},g=function(t){t.state=e;if(t.type!=u&&t.tasks){t.currentIndex=0;for(var n=0;n<t.tasks.length;n++)g(t.tasks[n])}},y=function(e){var t=this.prototype,n={};for(var r in t)n[r]=t[r];for(var r in e)n[r]=e[r];return n},b=function(e){var t=""+p++;return e?e+t:c+t},w=d.Task=function(e,t){var n=w.extend(e);return n.tid=b(),n.decorators=[],n.count&&T(n),n.when&&C(n),n.while&&N(n),n};w.prototype={type:u,name:u,state:e,cancel:function(){if(this.state>t)return;this.state=n,this.loggingEnabled&&console.log("Canceled:"+this.name),this.onChange(this.state),this.onCancel()},complete:function(){if(this.state>t)return;this.state=i,this.loggingEnabled&&console.log("Completed:"+this.name),this.executionTime=(new Date).getTime()-this.startTime,this.onComplete(),this.onChange(this.state)},fault:function(e){if(this.state>=n)return;this.state=r,this.loggingEnabled&&console.log("Faulted:"+this.name),this.onChange(this.state,e),this.onFault(e)},onChange:function(e,t){},onStart:function(){},onFault:function(e){},onComplete:function(){},onCancel:function(){},performTask:function(){throw"'performTask' method should be overridden"},start:function(){if(this.state>=t)return;this.startTime=(new Date).getTime(),this.state=t,this.loggingEnabled&&console.log("Started:"+this.name),this.onChange(this.state),this.performTask(),this.onStart()}};var E=d.TaskGroup=function(e,t){return e=E.extend(e),e.tasks=m(e.tasks),new w(e,t)};E.prototype={currentIndex:0,addSubTask:function(e){e.id||(e=v(e)),this.tasks.push(e)},addSubTaskAfterTask:function(e,t){if(!e||this.state==n)return;e.id||(e=v(e));var r=this.tasks.indexOf(t);this.tasks.splice(r,0,e)},onSubTaskComplete:function(){throw"This is an abstract method and must be implemented in a subclass."},onSubTaskFault:function(e){this.fault(e)},onSubTaskCancel:function(e){this.cancel()},processSubTask:function(e){if(!e)throw"You cannot process a task with a nil value.";return e.state==n?(console.log("task is canceled"),this.onSubTaskCancel(e),!0):(e.group=this,e.loggingEnabled=this.loggingEnabled,e.onChange=function(t,s){t==i?this.group.onSubTaskComplete():t==r?this.group.onSubTaskFault(s):t==n&&this.group.onSubTaskCancel(e)},e.start(),!1)},removeSubTask:function(e){if(!e)return;var t=this.tasks.indexOf(e);this.tasks.splice(t,1)}};var S=d.ParallelTask=function(e,t){return e=S.extend(e),new E(e,t)};S.prototype={type:s,name:s,hasNoEnabledSubTasks:function(){for(var e=0;e<this.tasks.length;e++){var t=this.tasks[e];if(t.state!=n)return!1}return!0},processSubTasks:function(){for(var e=0;e<this.tasks.length;e++){var t=this.tasks[e];this.currentIndex++,this.processSubTask(t)}},addSubTask:function(e){if(!e||e.state==n)return;this.currentIndex++,e.id||(e=new w(e)),this.tasks.push(e),this.processSubTask(e)},onSubTaskComplete:function(){this.currentIndex=this.currentIndex++,this.currentIndex==this.tasks.length&&this.complete()},performTask:function(){this.hasNoEnabledSubTasks()?this.complete():this.processSubTasks()}};var x=d.SequenceTask=function(e,t){return e=x.extend(e),new E(e,t)};x.prototype={type:o,name:o,startNextSubTask:function(){if(this.state>=n)return;if(this.tasks&&this.currentIndex<this.tasks.length){var e=this.processSubTask(this.tasks[this.currentIndex++]);e&&this.startNextSubTask()}else this.complete()},onSubTaskComplete:function(){if(this.state==n)return;this.startNextSubTask()},onSubTaskCancel:function(e){this.state!=n&&this.startNextSubTask()},performTask:function(){this.startNextSubTask()}},w.extend=E.extend=S.extend=x.extend=y;var T=function(e){return e.count=e.count?e.count:1,e.itterationIndex=T.prototype.itterationIndex,e.complete=T.prototype.complete,e.decorators.push(a),e};T.prototype={itterationIndex:0,complete:function(){this.itterationIndex!=this.count-1?(g(this),this.itterationIndex++,this.loggingEnabled&&console.log("Completed:"+this.name+" "+this.itterationIndex+" out of "+this.count+" times"),this.performTask()):w.prototype.complete.call(this)}};var N=function(e){return e.interval=e.interval?e.interval:100,e.complete=N.prototype.complete,e.decorators.push(l),e};N.prototype={complete:function(){if(this.while()){this.state=e;var t=this;this.interval!=0?setTimeout(function(){t.start()},this.interval):t.start()}else w.prototype.complete.call(this)}};var C=function(e){return e.start=C.prototype.start,e.decorators.push(f),e};C.prototype={start:function(){var e=this.interval?this.interval:10;if(this.when())w.prototype.start.call(this);else{var t=this;setTimeout(function(){t.start()},e)}}},d.TaskStates={Initialized:e,Started:t,Canceled:n,Faulted:r,Completed:i},d.TaskTypes={Parallel:s,Sequence:o,Simple:u},d.TaskDecorators={For:a,When:f,While:l},h.MonkeyBars=d})(this);